<Window x:Class="NutritionOptimizer.UI.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="식단 최적화 프로그램"
        Height="900"
        Width="1400">
    <Window.Resources>
        <!-- 헤더 중앙 정렬 스타일 -->
        <Style x:Key="CenterHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="HorizontalContentAlignment" Value="Center" />
        </Style>
        <!-- 셀 우측 정렬 스타일 (숫자용) -->
        <Style x:Key="RightAlignCell" TargetType="TextBlock">
            <Setter Property="HorizontalAlignment" Value="Right" />
            <Setter Property="Margin" Value="0,0,4,0" />
        </Style>
        <!-- 셀 중앙 정렬 스타일 (날짜/브랜드/카테고리용) -->
        <Style x:Key="CenterAlignCell" TargetType="TextBlock">
            <Setter Property="HorizontalAlignment" Value="Center" />
        </Style>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="300" />
        </Grid.RowDefinitions>

        <!-- 상단 컨트롤 패널 -->
        <Grid Grid.Row="0" Background="#F5F5F5" Margin="0 0 0 8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- 첫 번째 줄: 데이터 관리 및 음식 관리 -->
            <WrapPanel Grid.Row="0" Margin="12 12 12 6" Orientation="Horizontal">
                <!-- 데이터 관리 -->
                <GroupBox Header="데이터 관리" Margin="0 0 12 0" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="💾 전체 데이터 로드" Command="{Binding LoadAllDataCommand}" Width="130" FontWeight="Bold" />
                    </StackPanel>
                </GroupBox>

                <!-- 음식 관리 -->
                <GroupBox Header="음식 관리" Margin="0 0 12 0" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="➕ 추가" Command="{Binding AddFoodCommand}" Width="70" Margin="0 0 4 0" />
                        <Button Content="✏️ 수정" Command="{Binding EditFoodCommand}" Width="70" Margin="0 0 4 0" />
                        <Button Content="🗑️ 삭제" Command="{Binding DeleteFoodCommand}" Width="70" Margin="0 0 4 0" />
                        <Button Content="🗑️ 다중 삭제" Command="{Binding DeleteSelectedFoodsCommand}" Width="90" />
                    </StackPanel>
                </GroupBox>

                <!-- 템플릿 관리 -->
                <GroupBox Header="템플릿 관리" Margin="0 0 12 0" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="📋 템플릿 관리" Command="{Binding OpenTemplateManagerCommand}" Width="110" />
                    </StackPanel>
                </GroupBox>

                <!-- 선호도 관리 -->
                <GroupBox Header="선호도 관리" Margin="0 0 12 0" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="⭐ 즐겨찾기" Command="{Binding ToggleFavoriteCommand}" Width="90" Margin="0 0 4 0" />
                        <Button Content="🚫 제외" Command="{Binding ToggleExcludedCommand}" Width="70" Margin="0 0 4 0" />
                        <Button Content="❌ 초기화" Command="{Binding ClearPreferenceCommand}" Width="70" />
                    </StackPanel>
                </GroupBox>

                <!-- 가격 관리 -->
                <GroupBox Header="가격 관리" Margin="0 0 12 0" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <DatePicker SelectedDate="{Binding CurrentDate, Converter={StaticResource DateOnlyConverter}}" Width="110" Margin="0 0 4 0" />
                        <Button Content="💰 가격 추가" Command="{Binding AddPriceHistoryCommand}" Width="90" Margin="0 0 4 0" />
                        <Button Content="📊 이력 보기" Command="{Binding LoadPriceHistoriesForSelectedFoodCommand}" Width="90" Margin="0 0 4 0" />
                        <Button Content="✔️ 가격 적용" Command="{Binding ApplyCurrentPricesCommand}" Width="90" />
                    </StackPanel>
                </GroupBox>

                <!-- 최적화 -->
                <GroupBox Header="최적화" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="모드:" VerticalAlignment="Center" Margin="0 0 4 0" />
                        <RadioButton Content="비용" 
                                     IsChecked="{Binding OptimizationMode, Converter={StaticResource RadioButtonConverter}, ConverterParameter=Cost}"
                                     VerticalAlignment="Center" 
                                     Margin="0 0 8 0"
                                     ToolTip="비용을 최우선으로 최소화합니다" />
                        <RadioButton Content="균형" 
                                     IsChecked="{Binding OptimizationMode, Converter={StaticResource RadioButtonConverter}, ConverterParameter=Balanced}"
                                     VerticalAlignment="Center" 
                                     Margin="0 0 8 0"
                                     ToolTip="비용과 영양을 적당히 균형있게 최적화합니다" />
                        <RadioButton Content="영양" 
                                     IsChecked="{Binding OptimizationMode, Converter={StaticResource RadioButtonConverter}, ConverterParameter=Nutrition}"
                                     VerticalAlignment="Center" 
                                     Margin="0 0 12 0"
                                     ToolTip="영양 목표치를 최우선으로 달성합니다" />
                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="0 0 8 0" />
                        <CheckBox Content="✅ 선택한 음식만" 
                                  IsChecked="{Binding UseSelectedFoodsOnly}" 
                                  VerticalAlignment="Center" 
                                  Margin="0 0 12 0"
                                  ToolTip="체크하면 음식 목록에서 선택한 음식만 사용합니다" />
                        <TextBlock Text="단위(g):" VerticalAlignment="Center" Margin="0 0 4 0" />
                        <TextBox Text="{Binding StepG}" Width="50" VerticalAlignment="Center" Margin="0 0 8 0" />
                        <Button Content="🛠️ 설정" Command="{Binding OpenCategoryConstraintsCommand}" Width="70" Margin="0 0 4 0" />
                        <Button Content="🎯 실행" Command="{Binding OptimizeCommand}" Width="70" FontWeight="Bold" />
                    </StackPanel>
                </GroupBox>

                <!-- 식단 관리 -->
                <GroupBox Header="식단 관리" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="💾 저장" Command="{Binding SaveCurrentDietCommand}" Width="70" Margin="0 0 4 0" />
                        <Button Content="📂 불러오기" Command="{Binding LoadSavedDietCommand}" Width="90" Margin="0 0 4 0" />
                        <Button Content="📋 목록" Command="{Binding LoadSavedDietsCommand}" Width="70" />
                    </StackPanel>
                </GroupBox>

                <!-- 히스토리 관리 -->
                <GroupBox Header="히스토리 관리" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="📅 히스토리 패널" Command="{Binding OpenHistoryPanelCommand}" Width="120" />
                    </StackPanel>
                </GroupBox>

                <!-- 차트 -->
                <GroupBox Header="시각화" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="📊 영양소 차트" Command="{Binding ShowNutrientChartCommand}" Width="120" Margin="0 0 4 0" />
                        <Button Content="📋 최적화 결과" Command="{Binding ShowOptimizationResultCommand}" Width="120" />
                    </StackPanel>
                </GroupBox>
            </WrapPanel>

            <!-- 두 번째 줄: 검색 및 필터 -->
            <WrapPanel Grid.Row="1" Margin="12 6 12 12" Orientation="Horizontal">
                <GroupBox Header="검색 및 필터" Padding="8">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="🔍" VerticalAlignment="Center" Margin="0 0 4 0" />
                        <TextBox Text="{Binding Query, UpdateSourceTrigger=PropertyChanged}" 
                                 Width="200" 
                                 VerticalAlignment="Center" 
                                 Margin="0 0 8 0" />
                        <CheckBox Content="유제품 제외" IsChecked="{Binding ExcludeDairy}" VerticalAlignment="Center" Margin="0 0 8 0" />
                        <CheckBox Content="가공식품 제외" IsChecked="{Binding ExcludeProcessed}" VerticalAlignment="Center" Margin="0 0 8 0" />
                        <CheckBox Content="⭐ 즐겨찾기만" IsChecked="{Binding ShowFavoritesOnly}" VerticalAlignment="Center" Margin="0 0 8 0" />
                        <CheckBox Content="🚫 제외 숨기기" IsChecked="{Binding HideExcluded}" VerticalAlignment="Center" />
                    </StackPanel>
                </GroupBox>

                <TextBlock Text="{Binding OptimizationStatus}" 
                           VerticalAlignment="Center" 
                           FontWeight="Bold" 
                           FontSize="14"
                           Margin="20 0 0 0" />
            </WrapPanel>
        </Grid>

        <!-- 중단: 음식 데이터 그리드 -->
        <GroupBox Grid.Row="1" Header="{Binding FoodsCountText}" Margin="12 0 12 8">
            <DataGrid x:Name="FoodDataGrid"
                      ItemsSource="{Binding FilteredFoods}"
                      SelectedItem="{Binding SelectedFood}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Extended"
                      AlternatingRowBackground="#F9F9F9"
                      MouseDoubleClick="FoodDataGrid_MouseDoubleClick"
                      SelectionChanged="FoodDataGrid_SelectionChanged">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="이름" Binding="{Binding Name}" Width="*" HeaderStyle="{StaticResource CenterHeaderStyle}" />
                    <DataGridTextColumn Header="구분" Binding="{Binding Type}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource CenterAlignCell}" />
                    <DataGridTextColumn Header="분류" Binding="{Binding Category}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource CenterAlignCell}" />
                    <DataGridTextColumn Header="총 가격" Binding="{Binding TotalPrice, StringFormat={}{0:N0}원}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="단위 당 가격" Binding="{Binding UnitPriceDisplay}" Width="90" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="칼로리" Binding="{Binding KcalDisplay}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="탄수화물(g)" Binding="{Binding CarbsGDisplay}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="단백질(g)" Binding="{Binding ProteinGDisplay}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="지방(g)" Binding="{Binding FatGDisplay}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="포화지방(g)" Binding="{Binding SaturatedFatGDisplay}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="나트륨(mg)" Binding="{Binding SodiumMgDisplay}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="식이섬유(g)" Binding="{Binding FiberGDisplay}" Width="80" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="당류(g)" Binding="{Binding SugarGDisplay}" Width="60" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    <DataGridTextColumn Header="콜레스테롤(mg)" Binding="{Binding CholesterolMgDisplay}" Width="95" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>

        <!-- 하단: 결과 패널 -->
        <Grid Grid.Row="2" Margin="12 0 12 12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- 목표치 -->
            <GroupBox Grid.Column="0" Header="{Binding TargetsCountText}" Margin="0 0 4 0">
                <DataGrid ItemsSource="{Binding Targets}"
                          SelectedItem="{Binding SelectedTarget}"
                          AutoGenerateColumns="False"
                          HeadersVisibility="Column"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          CellEditEnding="TargetsDataGrid_CellEditEnding">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="영양소" Binding="{Binding NutrientKey, Converter={StaticResource NutrientKeyConverter}}" Width="*" IsReadOnly="True" HeaderStyle="{StaticResource CenterHeaderStyle}" />
                        <DataGridTextColumn Header="최소" Binding="{Binding Min, Converter={StaticResource NullableDoubleConverter}, TargetNullValue=''}" Width="60" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                        <DataGridTextColumn Header="최대" Binding="{Binding Max, Converter={StaticResource NullableDoubleConverter}, TargetNullValue=''}" Width="60" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                        <DataGridTextColumn Header="권장" Binding="{Binding Recommended, Converter={StaticResource NullableDoubleConverter}, TargetNullValue=''}" Width="60" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                        <DataGridTextColumn Header="충분" Binding="{Binding Sufficient, Converter={StaticResource NullableDoubleConverter}, TargetNullValue=''}" Width="60" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                    </DataGrid.Columns>
                </DataGrid>
            </GroupBox>

            <!-- 저장된 식단 -->
            <GroupBox Grid.Column="1" Header="{Binding SavedDietsCountText}" Margin="4 0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0 0 0 4">
                        <Button Content="🗑️ 삭제" Command="{Binding DeleteSavedDietCommand}" Width="70" />
                    </StackPanel>

                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding SavedDiets}"
                              SelectedItem="{Binding SelectedSavedDiet}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="식단명" Binding="{Binding Name}" Width="*" HeaderStyle="{StaticResource CenterHeaderStyle}" />
                            <DataGridTextColumn Header="날짜" Binding="{Binding CreatedDate, StringFormat=MM-dd}" Width="50" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource CenterAlignCell}" />
                            <DataGridTextColumn Header="비용" Binding="{Binding TotalCost, StringFormat={}{0:N0}}" Width="60" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>

            <!-- 가격 이력 -->
            <GroupBox Grid.Column="2" Header="{Binding PriceHistoriesCountText}" Margin="4 0 0 0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0 0 0 4">
                        <Button Content="🗑️ 삭제" Command="{Binding DeletePriceHistoryCommand}" Width="60" Margin="0 0 4 0" />
                        <Button Content="🗑️ 다중 삭제" Command="{Binding DeleteSelectedPriceHistoriesCommand}" Width="90" />
                    </StackPanel>

                    <DataGrid Grid.Row="1"
                              x:Name="PriceHistoryDataGrid"
                              ItemsSource="{Binding PriceHistories}"
                              SelectedItem="{Binding SelectedPriceHistory}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              SelectionMode="Extended"
                              HeadersVisibility="Column"
                              SelectionChanged="PriceHistoryDataGrid_SelectionChanged">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="음식" Binding="{Binding FoodName}" Width="*" HeaderStyle="{StaticResource CenterHeaderStyle}" />
                            <DataGridTextColumn Header="날짜" Binding="{Binding EffectiveDate, StringFormat=yyyy-MM-dd}" Width="90" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource CenterAlignCell}" />
                            <DataGridTextColumn Header="총 가격" Binding="{Binding TotalPrice, StringFormat={}{0:N0}원}" Width="70" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                            <DataGridTextColumn Header="단위 당 가격" Binding="{Binding UnitPriceDisplay}" Width="90" HeaderStyle="{StaticResource CenterHeaderStyle}" ElementStyle="{StaticResource RightAlignCell}" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>
        </Grid>
    </Grid>
</Window>
