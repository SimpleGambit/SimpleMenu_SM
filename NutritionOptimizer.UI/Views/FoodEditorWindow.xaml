<Window x:Class="NutritionOptimizer.UI.Views.FoodEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:NutritionOptimizer.UI.Converters"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        Title="음식 추가/수정"
        Height="800"
        Width="900"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">
    <Window.Resources>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
    </Window.Resources>
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 제목 -->
        <TextBlock Grid.Row="0"
                   Text="음식 정보 입력"
                   FontSize="18"
                   FontWeight="Bold"
                   Margin="0 0 0 16" />

        <!-- 입력 폼 -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="450" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- 왼쪽: 템플릿 선택 및 목록 -->
                <StackPanel Grid.Column="0" Margin="0 0 12 0">
                    <!-- 템플릿 선택 -->
                    <GroupBox Header="🍽️ 템플릿 선택" Margin="0 0 0 12" Padding="12">
                        <StackPanel>
                            <TextBlock Text="템플릿 검색" FontWeight="SemiBold" Margin="0 0 0 4" />
                            <TextBox x:Name="TemplateSearchBox" 
                                     TextChanged="TemplateSearchBox_TextChanged"
                                     Margin="0 0 0 8" />
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <ComboBox Grid.Column="0"
                                          ItemsSource="{Binding Templates}"
                                          SelectedItem="{Binding CurrentTemplate}"
                                          Margin="0 0 8 0"
                                          Height="32">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Name}" />
                                                <TextBlock Foreground="Gray" Margin="4 0 0 0">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Brand}" Value="">
                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Brand}" Value="{x:Null}">
                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                    <Run Text="(" />
                                                    <Run Text="{Binding Brand}" />
                                                    <Run Text=")" />
                                                </TextBlock>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                
                                <Button Grid.Column="1"
                                        Content="➕ 추가"
                                        Command="{Binding AddTemplateCommand}"
                                        Width="70"
                                        Height="32" />
                            </Grid>
                            
                            <TextBlock Text="💡 템플릿은 100g 또는 100ml 기준 영양성분입니다" 
                                       Foreground="Gray" 
                                       FontSize="11" 
                                       Margin="0 8 0 0" />
                        </StackPanel>
                    </GroupBox>

                    <!-- 선택된 템플릿 목록 -->
                    <GroupBox Header="📋 선택된 템플릿" Padding="12">
                        <StackPanel>
                            <TextBlock Text="각 템플릿의 양을 입력하세요 (g 또는 ml)" 
                                       Foreground="Gray" 
                                       FontSize="11" 
                                       Margin="0 0 0 8" />
                            
                            <ItemsControl ItemsSource="{Binding SelectedTemplates}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="#E0E0E0" 
                                                BorderThickness="1" 
                                                CornerRadius="4" 
                                                Padding="12" 
                                                Margin="0 0 0 8"
                                                Background="White">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                </Grid.RowDefinitions>
                                                
                                                <!-- 템플릿 이름 및 제거 버튼 -->
                                                <Grid Grid.Row="0" Margin="0 0 0 8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Text="{Binding Template.Name}" 
                                                                   FontWeight="Bold" 
                                                                   FontSize="14" />
                                                        <TextBlock>
                                                            <Run Text="{Binding Template.Type}" Foreground="DarkBlue" />
                                                            <Run Text=" / " />
                                                            <Run Text="{Binding Template.Category}" Foreground="Gray" />
                                                        </TextBlock>
                                                    </StackPanel>
                                                    
                                                    <Button Grid.Column="1" 
                                                            Content="🗑️"
                                                            Command="{Binding DataContext.RemoveTemplateCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding}"
                                                            Width="32"
                                                            Height="32"
                                                            ToolTip="템플릿 제거" />
                                                </Grid>
                                                
                                                <!-- 브랜드 표시 -->
                                                <Grid Grid.Row="1" Margin="0 0 0 8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <TextBlock Grid.Column="0" 
                                                               Text="브랜드:" 
                                                               VerticalAlignment="Center"
                                                               FontWeight="SemiBold"
                                                               Margin="0 0 8 0" />
                                                    
                                                    <TextBlock Grid.Column="1" 
                                                               Text="{Binding Template.Brand}"
                                                               VerticalAlignment="Center"
                                                               Foreground="Gray" />
                                                </Grid>
                                                
                                                <!-- 양 입력 (단위는 템플릿에 따라 g 또는 ml) -->
                                                <Grid Grid.Row="2" Margin="0 0 0 8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <TextBlock Grid.Column="0" 
                                                               VerticalAlignment="Center"
                                                               FontWeight="SemiBold"
                                                               Margin="0 0 8 0">
                                                        <Run Text="양(" />
                                                        <Run Text="{Binding Unit, Mode=OneWay}" />
                                                        <Run Text="):" />
                                                    </TextBlock>
                                                    
                                                    <TextBox Grid.Column="1" 
                                                             Text="{Binding AmountG, UpdateSourceTrigger=LostFocus}"
                                                             Height="32"
                                                             VerticalContentAlignment="Center" />
                                                    
                                                    <TextBlock Grid.Column="2" 
                                                               Text="{Binding Unit, Mode=OneWay}" 
                                                               VerticalAlignment="Center"
                                                               Margin="8 0 0 0"
                                                               FontWeight="SemiBold" />
                                                </Grid>
                                                
                                                <!-- 가격 표시 -->
                                                <Grid Grid.Row="3">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <TextBlock Grid.Column="0" 
                                                               Text="가격:" 
                                                               VerticalAlignment="Center"
                                                               FontWeight="SemiBold"
                                                               Margin="0 0 8 0" />
                                                    
                                                    <TextBlock Grid.Column="1" 
                                                               VerticalAlignment="Center"
                                                               FontWeight="Bold"
                                                               Foreground="DarkGreen">
                                                        <Run Text="{Binding CalculatedPrice, StringFormat=N0}" />
                                                        <Run Text="원" />
                                                    </TextBlock>
                                                </Grid>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            
                            <!-- 템플릿이 없을 때 -->
                            <TextBlock Text="추가된 템플릿이 없습니다"
                                       Foreground="Gray"
                                       FontStyle="Italic"
                                       HorizontalAlignment="Center"
                                       Margin="0 20 0 0"
                                       Visibility="{Binding SelectedTemplates.Count, Converter={StaticResource CountToVisibilityConverter}}" />
                        </StackPanel>
                    </GroupBox>
                </StackPanel>

                <!-- 오른쪽: 음식 정보 및 영양성분 -->
                <StackPanel Grid.Column="1">
                    <!-- 기본 정보 -->
                    <GroupBox Header="📝 음식 정보" Margin="0 0 0 12" Padding="12">
                        <StackPanel>
                            <!-- ID -->
                            <TextBlock Text="ID" FontWeight="SemiBold" />
                            <TextBox Text="{Binding Id}"
                                     IsReadOnly="True"
                                     Background="#F5F5F5"
                                     Margin="0 4 0 12" />

                            <!-- 이름 -->
                            <TextBlock Text="이름 *" FontWeight="SemiBold" />
                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0 4 0 12" />

                            <!-- 구분 (템플릿에서 자동 설정) -->
                            <TextBlock Text="구분 (자동)" FontWeight="SemiBold" Foreground="Gray" />
                            <TextBox Text="{Binding Type}"
                                     IsReadOnly="True"
                                     Background="#F5F5F5"
                                     Margin="0 4 0 12" />

                            <!-- 분류 (수정 가능) -->
                            <TextBlock FontWeight="SemiBold" Margin="0 0 0 4">
                                <Run Text="분류 *" />
                                <Run Text=" (템플릿 2개 이상시 직접 입력)" FontSize="11" Foreground="DarkOrange" />
                            </TextBlock>
                            <TextBox Text="{Binding Category, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0 0 0 12" />

                            <!-- 조리 방법 -->
                            <TextBlock Text="조리 방법" FontWeight="SemiBold" />
                            <ComboBox SelectedItem="{Binding CookingMethod}"
                                      Margin="0 4 0 4"
                                      Height="32">
                                <System:String>없음</System:String>
                                <System:String>가열조리</System:String>
                                <System:String>튀김</System:String>
                                <System:String>취사</System:String>
                            </ComboBox>
                            <TextBlock Foreground="Gray" 
                                       FontSize="11" 
                                       Margin="0 4 0 12">
                                <Run Text="💡 가열조리/튀김: 비타민 손실률 자동 적용" />
                                <LineBreak />
                                <Run Text="💡 취사(쌀 전용): 무게 2.8배 증가, 수용성 비타민 일부 감소" />
                            </TextBlock>

                            <!-- 총 무게 (자동 계산) -->
                            <TextBlock Text="총 무게 (자동 계산)" FontWeight="SemiBold" Foreground="Gray" />
                            <TextBox Text="{Binding WeightUnit}"
                                     IsReadOnly="True"
                                     Background="#F5F5F5"
                                     Margin="0 4 0 12" />

                            <!-- 총 가격 (자동 계산) -->
                            <TextBlock Text="💰 총 가격 (원)" FontWeight="SemiBold" Foreground="DarkGreen" />
                            <TextBox Text="{Binding TotalPrice, StringFormat=N2}"
                                     IsReadOnly="True"
                                     Background="#F5F5F5"
                                     FontWeight="Bold"
                                     FontSize="14"
                                     Margin="0 4 0 12" />

                            <!-- 100g당 가격 (자동 계산) -->
                            <TextBlock Text="100g당 가격 (원)" FontWeight="SemiBold" Foreground="Gray" />
                            <TextBox Text="{Binding PricePer100g, StringFormat=N2}"
                                     IsReadOnly="True"
                                     Background="#F5F5F5"
                                     Margin="0 4 0 12" />

                            <!-- 메모 -->
                            <TextBlock Text="메모" FontWeight="SemiBold" />
                            <TextBox Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                                     Height="60"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     VerticalScrollBarVisibility="Auto"
                                     Margin="0 4 0 0" />
                        </StackPanel>
                    </GroupBox>

                    <!-- 영양성분 요약 -->
                    <TextBlock Text="💡 영양성분은 선택된 모든 템플릿의 합계입니다 (자동 계산)" 
                               Foreground="Gray" 
                               FontSize="12" 
                               Margin="0 0 0 8" />

                    <!-- 주요 영양소 -->
                    <GroupBox Header="🥗 주요 영양소 (총합)" Padding="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- 칼로리 -->
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="열량" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="0" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N1} kcal">
                                        <Binding Path="Kcal" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- 단백질 -->
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="단백질" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="1" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N2} g">
                                        <Binding Path="ProteinG" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- 지방 -->
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="지방" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="2" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N2} g">
                                        <Binding Path="FatG" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- 포화지방 -->
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="포화지방" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="3" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N2} g">
                                        <Binding Path="SaturatedFatG" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- 트랜스지방 -->
                            <TextBlock Grid.Row="4" Grid.Column="0" Text="트랜스지방" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="4" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N2} g">
                                        <Binding Path="TransFatG" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- 탄수화물 -->
                            <TextBlock Grid.Row="5" Grid.Column="0" Text="탄수화물" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="5" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N2} g">
                                        <Binding Path="CarbsG" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- 식이섬유 -->
                            <TextBlock Grid.Row="6" Grid.Column="0" Text="식이섬유" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="6" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N2} g">
                                        <Binding Path="FiberG" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- 당류 -->
                            <TextBlock Grid.Row="7" Grid.Column="0" Text="당류" FontWeight="SemiBold" Margin="0 0 8 4" />
                            <TextBox Grid.Row="7" Grid.Column="1" IsReadOnly="True" Background="#F5F5F5" Margin="0 0 0 8">
                                <TextBox.Text>
                                    <MultiBinding StringFormat="{}{0:N2} g">
                                        <Binding Path="SugarG" />
                                    </MultiBinding>
                                </TextBox.Text>
                            </TextBox>
                        </Grid>
                    </GroupBox>
                </StackPanel>
            </Grid>
        </ScrollViewer>

        <!-- 버튼 -->
        <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0 16 0 0">
            <Button Content="💾 저장"
                    Width="100"
                    Height="36"
                    FontSize="14"
                    Margin="0 0 8 0"
                    Click="SaveButton_Click" />
            <Button Content="❌ 취소"
                    Width="100"
                    Height="36"
                    FontSize="14"
                    Click="CancelButton_Click" />
        </StackPanel>
    </Grid>
</Window>
